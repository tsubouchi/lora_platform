# VRM-LoRAプラットフォーム総合設計書

## 1. プロジェクト概要

### 目的
ユーザーがVRM形式の3Dアバターをアップロードすると、クラウド上で自動的に以下の機能を提供するサービスを構築します：

1. **LoRAモデル生成機能**：アップロードされたVRMファイルからLoRA（Low-Rank Adaptation）モデルを自動生成
2. **データセット生成機能**：VRMファイルから指定された条件（角度、表情、ライティング、カメラ距離）の自動スクリーンショット撮影によるデータセット作成

これにより、AIコンテンツ生成のワークフローを効率化し、動画対応や静止画生成向けのカスタムモデルを容易に作成できる環境を実現します。

### 対象ユーザー
- 3Dアバターを活用したコンテンツクリエイター
- AI研究者、開発チーム
- キャラクターデザイナー

### 主な機能
- VRMファイルのアップロード／管理
- 非同期ジョブによるLoRA作成プロセスの自動実行
- ヘッドレスブラウザを使用した自動スクリーンショット撮影
- 360度回転、表情、ライティング、カメラ距離などの組み合わせによるデータセット作成
- Linuxサンドボックス上でのセキュアな学習環境の提供
- 進捗状況のモニタリングとログ管理
- AIエージェントによる品質評価とフィードバックの実装

## 2. システムアーキテクチャ

### 2.1 コンポーネント概要
- **フロントエンド**：React/ChakraUIベースのWebアプリケーション
- **バックエンド**：FastAPIによるREST API
- **データベース**：SQLAlchemyによるORMを使用したジョブ管理
- **ジョブプロセッサ**：非同期処理によるジョブ管理
- **ストレージ**：ファイル保存用ディレクトリ構造
- **ヘッドレスブラウザ**：Pyppeteerを使用したVRM Viewer自動操作

### 2.2 システム構成図
```
[ユーザー] <-> [フロントエンド] <-> [バックエンドAPI] <-> [ジョブプロセッサ]
                                       |                |
                                       v                v
                                  [データベース]    [ストレージ]
                                                      |
                                                      v
                                              [ヘッドレスブラウザ]
                                                      |
                                                      v
                                              [VRM Viewer操作]
```

## 3. 機能詳細

### 3.1 LoRA生成機能

#### 3.1.1 プロセスフロー
1. ユーザーがVRMファイルをアップロード
2. LoRA生成パラメータを設定
3. 非同期ジョブとして処理を開始
4. 進捗状況をリアルタイムで表示
5. 処理完了後、生成されたLoRAモデルをダウンロード可能

#### 3.1.2 パラメータ設定
- **ランク（Rank）**：LoRAの次元数
- **アルファ（Alpha）**：スケーリング係数
- **イテレーション数**：学習反復回数
- **バッチサイズ**：一括処理数
- **学習率**：モデル調整速度
- **解像度**：生成画像の解像度
- **高度な設定**：オプションの追加設定

### 3.2 データセット生成機能

#### 3.2.1 プロセスフロー
1. ユーザーがVRMファイルをアップロード
2. データセット生成パラメータを設定
3. ヘッドレスブラウザによる自動スクリーンショット撮影をジョブとして実行
4. 進捗状況をリアルタイムで表示
5. 処理完了後、生成されたデータセット（ZIPファイル）をダウンロード可能

#### 3.2.2 パラメータ設定
- **角度設定**：
  - 開始角度（0°～359°、デフォルト：0°）
  - 終了角度（0°～359°、デフォルト：350°）
  - 角度間隔（デフォルト：10°）
  
- **表情設定**：
  - 利用可能な表情：Neutral, Happy, Sad, Angry, Surprised, Relaxed, Worried, Confused
  - 複数選択可能
  
- **ライティング設定**：
  - 利用可能なライティング：Normal, Bright, Dark, Warm, Cool, Side, Dramatic, Soft
  - 複数選択可能
  
- **カメラ距離設定**：
  - 利用可能な距離：Close, Mid, Far
  - 複数選択可能

#### 3.2.3 生成ショット数の計算
総ショット数 = 角度数 × 表情数 × ライティング数 × カメラ距離数

例：36角度 × 1表情 × 1ライティング × 1距離 = 36枚（最小構成）
例：36角度 × 5表情 × 3ライティング × 3距離 = 1,620枚（拡張構成）

#### 3.2.4 ヘッドレスブラウザ実装詳細
- **使用技術**：Pyppeteer（Puppeteerのpython実装）
- **操作対象**：VRM Viewer（https://vrm-viewer.com/）
- **操作手順**：
  1. ブラウザの起動と初期化
  2. VRM Viewerページにアクセス
  3. VRMファイルのアップロード
  4. 表情の設定（_set_expressionメソッド）
  5. ライティングの設定（_set_lightingメソッド）
  6. カメラ距離の設定（_set_camera_distanceメソッド）
  7. モデルの回転（_rotate_modelメソッド）
  8. スクリーンショットの撮影と保存
  9. メタデータの記録
  10. ZIP形式での圧縮と出力

## 4. 技術スタック

### 4.1 バックエンド
- Python 3.8+
- FastAPI (Webフレームワーク)
- SQLAlchemy + SQLite (データベース)
- Pydantic (データバリデーション)
- asyncio (非同期処理)
- Pyppeteer (ヘッドレスブラウザ操作)
- Chromiumバージョン管理システム (環境適応型)
- Python標準ライブラリ (os, logging, multiprocessing など)

### 4.2 Pythonパッケージ構造
- モジュール間の絶対インポート方式を採用
- Pythonパッケージとしての実行環境
- 関数とクラスの一貫性のある命名規則
- クリーンなディレクトリ構造の維持
- 環境変数とパスの設定管理

### 4.3 フロントエンド
- React (UIフレームワーク)
- Chakra UI (UIコンポーネント)
- WebSocket (リアルタイム通信)
- Fetch API (バックエンド通信)
- React Hooks (状態管理)

### 4.4 データ保存
- SQLite (ジョブ管理用データベース)
- ファイルベースストレージ (VRMファイル、生成データ)
- JSON (設定とパラメータ保存)

## 5. データ構造と保存形式

### 5.1 ジョブデータ
```json
{
  "job_id": "uuid",
  "status": "queued|processing|completed|error",
  "job_type": "lora|dataset",
  "submission_time": "ISO datetime",
  "start_time": "ISO datetime",
  "end_time": "ISO datetime",
  "file_path": "path/to/vrm/file",
  "job_parameters": "{json string}",
  "progress": 0-100,
  "message": "現在の状態メッセージ",
  "error_message": "エラー発生時のメッセージ"
}
```

### 5.2 データセットメタデータ
```json
{
  "job_id": "uuid",
  "vrm_file": "filename.vrm",
  "parameters": {
    "angle_start": 0,
    "angle_end": 350,
    "angle_step": 10,
    "expressions": ["Neutral"],
    "lighting": ["Normal"],
    "camera_distance": ["Mid"]
  },
  "total_shots": 36,
  "shots": [
    {
      "filename": "shot_Neutral_Normal_Mid_angle000.png",
      "expression": "Neutral",
      "lighting": "Normal",
      "camera_distance": "Mid",
      "angle": 0
    },
    // ...more shots
  ]
}
```

### 5.3 ファイル命名規則
- **スクリーンショット**：`shot_{expression}_{lighting}_{distance}_angle{angle}.png`
- **データセットZIP**：`{job_id}.zip`
- **LoRAモデル**：`{job_id}.safetensors`

## 6. API仕様

### 6.1 LoRA生成API
- `POST /jobs/generate` - LoRA生成ジョブの作成
- `GET /jobs/{job_id}/status` - ジョブステータスの取得
- `GET /jobs/{job_id}/download` - 生成されたモデルのダウンロード
- `GET /jobs` - 全ジョブリストの取得

### 6.2 データセット生成API
- `POST /dataset/generate` - データセット生成ジョブの作成
- `GET /dataset/{job_id}/status` - データセット生成ジョブのステータス取得
- `GET /dataset/{job_id}/download` - 生成されたデータセットのダウンロード
- `GET /dataset/jobs` - データセット生成ジョブの一覧取得

## 7. セキュリティと最適化

### 7.1 セキュリティ対策
- ファイルサイズ制限 (50MB)
- ファイル形式の検証 (.vrm のみ)
- サンドボックス環境でのジョブ実行
- アップロードディレクトリの分離

### 7.2 パフォーマンス最適化
- 非同期処理によるジョブ実行
- 適切なタイミングでの一時ファイルのクリーンアップ
- プログレッシブなUIによるユーザー体験の向上
- 大量ショット生成時の警告と確認

## 8. 今後の拡張予定

### 8.1 機能拡張
- AIによる生成画像の品質評価
- より多くの表情・ライティング・カメラアングルのサポート
- バッチ処理による複数VRMファイルの一括処理
- クラウドストレージ連携（GCP, AWS S3など）

### 8.2 UI/UX改善
- ダークモード対応
- プレビュー機能の強化
- モバイル対応の改善
- 生成結果の詳細ビューアの強化

## 9. 開発ロードマップ

### フェーズ1（実装済み）
- 基本的なLoRA生成パイプライン
- ヘッドレスブラウザによるデータセット生成
- フロントエンドとバックエンドの統合
- ジョブ管理システム

### フェーズ2（開発中）
- UI/UX改善
- エラーハンドリングの強化
- ドキュメントの整備
- テスト環境の構築

### フェーズ3（計画中）
- AIによる品質評価の追加
- 本番環境のデプロイ
- ユーザー管理システムの追加
- API機能の拡張

## 10. 最新の改善点

### 10.1 VRMビューワーの改善
- **タイムアウト処理の強化**：VRMモデルの読み込みが30秒を超えた場合に強制的にローディング表示を非表示にする機能を追加
- **エラー状態対応**：エラー発生時もローディング表示を非表示にする処理を追加
- **コンソールログの強化**：診断用のログ出力を拡充

### 10.2 dataset_generator.pyの改善
- **タイムアウト処理の改善**：`_navigate_to_viewer`メソッドのタイムアウトを120秒に延長
- **エラー診断機能**：スクリーンショットとHTMLキャプチャ機能を追加して診断を容易化
- **待機プロセスの改善**：複数ステップの待機と確認プロセスを導入
- **フォールバック機構**：ロード状態が維持される場合に強制的に解除する機能

### 10.3 スクリーンショットディレクトリ問題の解決
- **複数ディレクトリ対応**：スクリーンショットディレクトリを複数の場所に作成（相対パスと絶対パスの両方をサポート）
- **フォールバック機構**：ディレクトリが存在しない場合の代替機能を提供
- **ダミースクリーンショット**：スクリーンショット生成に失敗した場合のダミー生成機能

### 10.4 ストレージディレクトリ構造の改善
- **統一されたパス管理**：相対パスではなく、プロジェクトルートからの一貫したパス構造を採用
- **ディレクトリ存在確認**：必要なディレクトリの自動確認と作成機能
- **スクリーンショット保存改善**：`storage/temp/screenshots/{job_id}` ディレクトリ構造に統一

### 10.5 ミニマルモードの導入
- **use_minimal=true パラメータ**：シンプルな設定でデータセット生成を実行するショートカット
- **処理時間の短縮**：標準設定よりも少ない組み合わせでデータセットを生成
- **リソース使用量の最適化**：メモリと処理時間の効率化

これらの改善により、VRMファイルからのデータセット生成の信頼性と効率が大幅に向上しました。システムはより堅牢になり、さまざまなVRMファイルに対応できるようになりました。

## 11. 結論

このプラットフォームにより、VRMファイルからLoRAモデルへの変換と、3Dアバターのデータセット生成を効率的に行うことができます。ヘッドレスブラウザによる自動スクリーンショット撮影機能により、多様な条件下での画像を簡単に生成でき、AIモデルの学習に適したデータセットを短時間で作成できるようになりました。

フロントエンドとバックエンドの緊密な連携、非同期処理によるスケーラブルな設計、ユーザーフレンドリーなインターフェイスにより、専門知識がなくてもVRMモデルの可能性を最大限に引き出すことが可能です。

今後も継続的な機能改善とバグ修正を行い、より使いやすく強力なプラットフォームを目指します。

---

# 実装詳細

## ディレクトリ構造

```
lora_platform/
├── backend/
│   ├── api/
│   │   ├── dataset.py  - データセット生成API
│   │   │   ├── dataset.py  - データセット生成API
│   │   └── job.py      - LoRA生成ジョブAPI
│   ├── models/
│   │   └── database.py - データベースモデル
│   ├── services/
│   │   └── job_service.py - ジョブサービス
│   ├── utils/
│   │   └── file_utils.py - ファイル操作ユーティリティ
│   ├── dataset_generator.py - データセット生成モジュール
│   ├── job_processor.py - ジョブ処理モジュール
│   ├── main.py - アプリケーションエントリポイント
│   └── requirements.txt - 依存関係
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── DatasetGenerator.jsx - データセット生成UI
│   │   │   ├── JobDetailsViewer.jsx - ジョブ詳細表示
│   │   │   ├── JobProgressTracker.jsx - ジョブ進捗表示
│   │   │   ├── Layout.jsx - レイアウトコンポーネント
│   │   │   └── VRMtoLoRAConverter.jsx - LoRA変換UI
│   │   ├── pages/
│   │   │   └── index.jsx - メインページ
│   │   └── App.js - アプリケーションコンポーネント
│   └── package.json - フロントエンド依存関係
├── scripts/
│   ├── clean_processes.sh - プロセスクリーンアップスクリプト
│   ├── install_chakra_ui.sh - Chakra UI インストールスクリプト
│   └── run_frontend.sh - フロントエンド起動スクリプト
├── storage/ - ファイル保存ディレクトリ
│   ├── datasets/ - 生成されたデータセット
│   ├── logs/ - ログファイル
│   ├── results/ - 生成結果
│   ├── uploads/ - アップロードファイル
│   └── chromium/ - Chromium関連ファイル
└── README.md - プロジェクト説明
```

## Pythonパッケージ構造と注意点

### インポート方法の注意点

バックエンドのコードでは、モジュール間のインポート方法に注意が必要です。プロジェクトを安定して実行するために、以下のインポート規則に従ってください：

#### 1. 相対インポートの使用方法

相対インポート（`from . import module`や`from .. import module`）は、Pythonパッケージとして実行する場合にのみ正しく動作します。スクリプトとして直接実行する場合（`python file.py`）、相対インポートは機能しません。

**問題例**:
```python
# このようなインポート文は直接実行時にエラーを引き起こします
from . import job_processor
from ..models.database import Job
```

#### 2. 絶対インポートへの変更

安定した実行のためには、相対インポートではなく絶対インポートを使用します：

**正しい例**:
```python
# 絶対インポートへの変更例
import backend.job_processor
from backend.models.database import Job
```

または、パッケージ内で実行する場合：

```python
# 同じディレクトリ内のモジュールのインポート
import job_processor
# サブディレクトリ内のモジュールのインポート
from models.database import Job
```

#### 3. アプリケーション起動方法

プロジェクトを正しく起動するには、Pythonモジュールとして実行する必要があります：

```bash
# 正しい起動方法（ディレクトリ構造に応じて）
cd lora_platform
python -m uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

### その他の注意点

1. **定数の定義**: すべての必要な定数（`JOB_STATUSES`, `DATASET_DIR`など）がモジュールに正しく定義されていることを確認してください。

2. **関数名の整合性**: インポートされる関数名と実際に定義されている関数名が一致していることを確認してください（例: `generate_dataset_from_vrm`と`generate_dataset`）。

3. **ストレージディレクトリの構造**: 必要なすべてのディレクトリ（`uploads`, `datasets`, `logs`, `results`, `temp`, `chromium`）が`storage`ディレクトリ内に存在することを確認してください。

これらのガイドラインに従うことで、プロジェクトの起動時に発生する可能性のあるインポートエラーを防ぐことができます。